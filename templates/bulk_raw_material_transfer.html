{% extends 'base.html' %}
{% block content %}
<div class="page-wrapper">
    <div class="content">
        <div class="page-header">
            <div class="page-title">
                <h4>Bulk Raw Material Transfer</h4>
            </div>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <div class="alert-container">
            {% for category, message in messages %}
            <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
        </div>
        {% endif %}
        {% endwith %}

        <form method="POST" action="/bulk_transfer">
            <!-- Dish Dropdown -->
            <div class="form-group">
                <label for="dish_id">Select Dish</label>
                <select id="dish_id" name="dish_id" class="form-control" onchange="fetchRawMaterials()" required>
                    <option value="" disabled selected>Choose a dish</option>
                    {% for dish in dishes %}
                    <option value="{{ dish['id'] }}">{{ dish['name'] }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Raw Materials Table -->
            <div class="card mt-3">
                <div class="card-body">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Raw Material</th>
                                <th>Available Quantity</th>
                                <th>Transfer Quantity</th>
                                <th>Metric</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="raw-materials-table">
                            <!-- Dynamic content will be populated here -->
                        </tbody>
                    </table>

                    <div class="mt-3">
                        <button type="submit" class="btn btn-primary">Submit Transfer</button>
                        <a href="/" class="btn btn-cancel">Cancel</a>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function fetchRawMaterials() {
        const dishId = document.getElementById('dish_id').value;

        if (dishId) {
            fetch(`/get_raw_materials/${dishId}`)
                .then(response => response.json())
                .then(data => {
                    const tableBody = document.getElementById('raw-materials-table');
                    tableBody.innerHTML = '';

                    data.raw_materials.forEach(material => {
                        const row = `
                            <tr id="material-row-${material.id}">
                                <td>
                                    <input type="text" name="material_${material.id}" 
                                        value="${material.name}" class="form-control" readonly>
                                </td>
                                <td>${material.available_quantity} ${material.metric}</td>
                                <td>
                                    <input type="number" name="transfer_quantity_${material.id}" 
                                        step="0.00001" class="form-control" max="${material.available_quantity}" required>
                                </td>
                                <td>${material.metric}</td>
                                <td>
                                    <button type="button" class="btn btn-danger btn-sm" 
                                        onclick="removeRawMaterial('${material.id}')">X</button>
                                </td>
                            </tr>
                        `;
                        tableBody.insertAdjacentHTML('beforeend', row);
                    });
                });
        }
    }

    function removeRawMaterial(materialId) {
        const row = document.getElementById(`material-row-${materialId}`);
        if (row) {
            row.remove();
        }
    }
</script>
{% endblock %}
