{% extends 'base.html' %}
{% block content %}
<div class="page-wrapper">
    <div class="content">
        <div class="page-header">
            <div class="page-title">
                <h4>PURCHASE LIST</h4>
                <h6>Manage your purchases</h6>
            </div>
        </div>

        <div class="card">
            <div class="card-body">
                <!-- Filter Row -->
                <div class="row align-items-center mb-4">
                    <div class="col-md-3">
                        <label for="vendorDropdown" class="form-label">Vendor</label>
                        <input list="vendorList" id="vendorDropdown" class="form-control">
                        <datalist id="vendorList">
                            {% for vendor in vendors %}
                            <option value="{{ vendor.vendor_name }}" data-id="{{ vendor.id }}"></option>
                            {% endfor %}
                        </datalist>
                    </div>

                    <div class="col-md-3">
                        <label for="invoiceDropdown" class="form-label">Invoice</label>
                        <input list="invoiceList" id="invoiceDropdown" class="form-control" disabled>
                        <datalist id="invoiceList"></datalist>
                    </div>

                    <div class="col-md-3">
                        <label for="purchaseDateDropdown" class="form-label">Purchase Date</label>
                        <input list="purchaseDateList" id="purchaseDateDropdown" class="form-control" disabled>
                        <datalist id="purchaseDateList"></datalist>
                    </div>
                    <div class="col-md-3">
                        <label for="totalAmount" class="form-label">Total Purchased Amount (Rs)</label>
                        <input id="totalAmount" type="text" class="form-control" readonly>
                    </div>
                </div>

                <!-- Table -->
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Purchase ID</th>
                                <th>Invoice Number</th>
                                <th>Vendor</th>
                                <th>Raw Material</th>
                                <th>Quantity</th>
                                <th>Metric</th>
                                <th>Total Cost (Rs)</th>
                                <th>Purchase Date</th>
                                <th>Storage Room</th>
                            </tr>
                        </thead>
                        <tbody id="purchaseTableBody">
                            <tr>
                                <td colspan="9" class="text-center">No data found</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const vendorInput = document.getElementById('vendorDropdown');
        const invoiceInput = document.getElementById('invoiceDropdown');
        const purchaseDateInput = document.getElementById('purchaseDateDropdown');
        const vendorList = document.getElementById('vendorList');
        const invoiceList = document.getElementById('invoiceList');
        const purchaseDateList = document.getElementById('purchaseDateList');
        const totalAmountField = document.getElementById('totalAmount');
        const purchaseTableBody = document.getElementById('purchaseTableBody');

        function getVendorId(vendorName) {
            const option = Array.from(vendorList.options).find(opt => opt.value === vendorName);
            return option ? option.getAttribute('data-id') : null;
        }

        function resetInvoiceList() {
            invoiceList.innerHTML = '';
            invoiceInput.value = '';
            invoiceInput.disabled = true;
            resetPurchaseDateList();
        }

        function resetPurchaseDateList() {
            purchaseDateList.innerHTML = '';
            purchaseDateInput.value = '';
            purchaseDateInput.disabled = true;
            totalAmountField.value = '';
            purchaseTableBody.innerHTML = '<tr><td colspan="9" class="text-center">No data found</td></tr>';
        }

        vendorInput.addEventListener('input', function () {
            const vendorId = getVendorId(this.value);
            resetInvoiceList();
            if (vendorId) {
                fetch(`/get_invoices/${vendorId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data && data.length > 0) {
                            invoiceInput.disabled = false;
                            data.forEach(invoice => {
                                const option = document.createElement('option');
                                option.value = invoice;
                                invoiceList.appendChild(option);
                            });
                        }
                    });
            }
        });

        invoiceInput.addEventListener('input', function () {
            const vendorId = getVendorId(vendorInput.value);
            const invoiceNumber = this.value;
            resetPurchaseDateList();
            if (vendorId && invoiceNumber) {
                fetch(`/get_invoice_dates/${vendorId}/${invoiceNumber}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data && data.length > 0) {
                            purchaseDateInput.disabled = false;
                            data.forEach(date => {
                                const option = document.createElement('option');
                                option.value = date;
                                purchaseDateList.appendChild(option);
                            });
                        }
                    });
            }
        });

        purchaseDateInput.addEventListener('input', function () {
            const vendorId = getVendorId(vendorInput.value);
            const invoiceNumber = invoiceInput.value;
            const purchaseDate = this.value;
            if (vendorId && invoiceNumber && purchaseDate) {
                fetch(`/get_purchases/${vendorId}/${invoiceNumber}/${purchaseDate}`)
                    .then(response => response.json())
                    .then(data => {
                        totalAmountField.value = parseFloat(data.total_amount).toLocaleString('en-IN') || '0';
                        if (data.purchases && data.purchases.length > 0) {
                            purchaseTableBody.innerHTML = '';
                            data.purchases.forEach(purchase => {
                                const row = `
                                <tr>
                                    <td>${purchase.id}</td>
                                    <td>${purchase.invoice_number}</td>
                                    <td>${purchase.vendor_name}</td>
                                    <td>${purchase.raw_material_name}</td>
                                    <td>${parseFloat(purchase.quantity).toFixed(2)}</td>
                                    <td>${purchase.metric}</td>
                                    <td>${parseFloat(purchase.total_cost).toLocaleString('en-IN')}</td>
                                    <td>${purchase.purchase_date}</td>
                                    <td>${purchase.storageroom_name}</td>
                                </tr>`;
                                purchaseTableBody.insertAdjacentHTML('beforeend', row);
                            });
                        } else {
                            purchaseTableBody.innerHTML = '<tr><td colspan="9" class="text-center">No data found</td></tr>';
                        }
                    });
            }
        });
    });
</script>
{% endblock %}
