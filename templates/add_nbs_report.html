{% extends 'base.html' %}

{% block content %}
<div class="page-wrapper">
  <div class="content">
    <div class="page-header">
      <div class="page-title">
        <h4>Add NBS Daily Report</h4>
      </div>
    </div>

    <div class="card">
      <div class="card-body">
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <div class="flash-messages">
          {% for category, message in messages %}
          <div class="alert alert-{{ 'danger' if category=='error' else 'success' }}">
            {{ message }}
          </div>
          {% endfor %}
        </div>
        {% endif %}
        {% endwith %}

        <form method="POST" action="/add-nbs-report">
          <div class="row">
            <div class="col-md-6">
              <div class="form-group">
                <label for="report_date">Date</label>
                <input type="date" class="form-control" id="report_date" name="report_date" value="{{ today }}" {% if
                  user.role !='admin' %}disabled{% endif %} required>
                {% if user.role != 'admin' %}
                <input type="hidden" name="report_date" value="{{ today }}">
                {% endif %}
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <label for="restaurant_id">Branch (Restaurant)</label>
                <select class="form-control" id="restaurant_id" name="restaurant_id" {% if disable_restaurant_dropdown
                  %}disabled{% endif %} required>
                  <option value="">Select Branch</option>
                  {% for r in restaurants %}
                  <option value="{{ r.id }}" {% if r.id==selected_restaurant_id %}selected{% endif %}>
                    {{ r.restaurantname }}
                  </option>
                  {% endfor %}
                </select>
                {% if disable_restaurant_dropdown %}
                <input type="hidden" name="restaurant_id" value="{{ selected_restaurant_id }}">
                {% endif %}
              </div>
            </div>
          </div>

          <hr>
          <h5>Income Section</h5>
          <div class="row">
            <div class="col-md-4">
              <label for="petpooja_total">PetPooja Total</label>
              <input type="number" step="0.01" class="form-control" id="petpooja_total" name="petpooja_total" value="0">
            </div>
            <div class="col-md-4">
              <label for="ns_total">NS Total</label>
              <input type="number" step="0.01" class="form-control" id="ns_total" name="ns_total" value="0">
            </div>
            <div class="col-md-4">
              <label for="outdoor_catering">Outdoor Catering</label>
              <input type="number" step="0.01" class="form-control" id="outdoor_catering" name="outdoor_catering"
                value="0">
            </div>
          </div>

          <hr>
          <h5>Payment Methods</h5>
          <div class="row">
            <div class="col-md-4">
              <label for="upi">UPI</label>
              <input type="number" step="0.01" class="form-control" id="upi" name="upi" value="0">
            </div>
            <div class="col-md-4">
              <label for="cash">Cash</label>
              <input type="number" step="0.01" class="form-control" id="cash" name="cash" value="0">
            </div>
            <div class="col-md-4">
              <label for="r_expense">Misc Expense</label>
              <input type="number" step="0.01" class="form-control" id="r_expense" name="r_expense"
                value="{{ r_expense_prefill }}" disabled>
            </div>
          </div>

          <hr>
          <h5>Online Platforms</h5>
          <div class="row">
            <div class="col-md-6">
              <label for="swiggy">Swiggy</label>
              <input type="number" step="0.01" class="form-control" id="swiggy" name="swiggy" value="0">
            </div>
            <div class="col-md-6">
              <label for="zomato">Zomato</label>
              <input type="number" step="0.01" class="form-control" id="zomato" name="zomato" value="0">
            </div>
          </div>

          <div class="mt-4">
            <button type="submit" class="btn btn-primary">Save Report</button>
            <a href="{{ url_for('nbs_reports') }}" class="btn btn-secondary">Cancel</a>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Auto-calculate total income
    function calculateTotalIncome() {
      const petpooja = parseFloat(document.getElementById('petpooja_total').value) || 0;
      const ns = parseFloat(document.getElementById('ns_total').value) || 0;
      const outdoor = parseFloat(document.getElementById('outdoor_catering').value) || 0;
      console.log('Total Income:', petpooja + ns + outdoor);
    }

    // Auto-calculate net counter
    function calculateNetCounter() {
      const upi = parseFloat(document.getElementById('upi').value) || 0;
      const cash = parseFloat(document.getElementById('cash').value) || 0;
      const r_expense = parseFloat(document.getElementById('r_expense').value) || 0;
      console.log('Net Counter:', upi + cash + r_expense);
    }

    // Auto-calculate net petpooja (Swiggy + Zomato)
    function calculateNetPetPooja() {
      const swiggy = parseFloat(document.getElementById('swiggy').value) || 0;
      const zomato = parseFloat(document.getElementById('zomato').value) || 0;
      console.log('Net PetPooja (Swiggy + Zomato):', swiggy + zomato);
    }

    ['petpooja_total', 'ns_total', 'outdoor_catering'].forEach(id =>
      document.getElementById(id).addEventListener('input', calculateTotalIncome)
    );
    ['upi', 'cash', 'r_expense'].forEach(id =>
      document.getElementById(id).addEventListener('input', calculateNetCounter)
    );
    ['swiggy', 'zomato'].forEach(id =>
      document.getElementById(id).addEventListener('input', calculateNetPetPooja)
    );
  });
</script>
{% endblock %}