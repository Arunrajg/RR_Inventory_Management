{% extends 'base.html' %}
{% block content %}
<div class="page-wrapper">
  <div class="content">
    <div class="page-header">
      <div class="page-title">
        <h4>Add Miscellaneous Expense</h4>
      </div>
    </div>


    <form action="/addmiscitem" method="POST">
      <div class="card">
        <div class="card-body">
          <div class="row">


            <!-- Type of Expense (Dynamic) -->
            <div class="col-lg-6 col-sm-6 col-12">
              <div class="form-group">
                <label>Type of Expense</label>
                <select name="expense_type_id" id="type_of_expense" class="form-control" required>
                  <option value="">Select Expense Type</option>
                  {% for expense_type in expense_types %}
                  <option value="{{ expense_type.id }}" data-has-subcategory="{{ expense_type.has_subcategory }}">
                    {{ expense_type.type_name }}
                  </option>
                  {% endfor %}
                </select>
              </div>
            </div>


            <!-- Subcategory (Dynamic) -->
            <div class="col-lg-6 col-sm-6 col-12" id="subcategory_div" style="display:none;">
              <div class="form-group">
                <label>Subcategory</label>
                <select name="expense_subcategory_id" id="sub_category" class="form-control">
                  <option value="">Select Subcategory</option>
                </select>
                <div id="subcategory_loading" style="display:none;">
                  <small class="text-muted">Loading subcategories...</small>
                </div>
              </div>
            </div>


            <!-- Restaurant -->
            <div class="col-lg-6 col-sm-6 col-12">
              <div class="form-group">
                <label>Branch (Restaurant)</label>
                <select name="restaurant_id" class="form-control" required {% if disable_restaurant_dropdown
                  %}disabled{% endif %}>
                  <option value="">Select Branch</option>
                  {% for restaurant in restaurants %}
                  <option value="{{ restaurant.id }}" {% if restaurant.id==selected_restaurant_id %}selected{% endif %}>
                    {{ restaurant.restaurantname }}
                  </option>
                  {% endfor %}
                </select>
                {% if disable_restaurant_dropdown %}
                <!-- Hidden input to ensure value gets submitted even if dropdown is disabled -->
                <input type="hidden" name="restaurant_id" value="{{ selected_restaurant_id }}">
                {% endif %}
              </div>
            </div>


            <!-- Branch Manager -->
            <div class="col-lg-6 col-sm-6 col-12">
              <div class="form-group">
                <label>Branch Manager Name</label>
                <input type="text" name="branch_manager" class="form-control" required>
              </div>
            </div>


            <!-- Cost -->
            <div class="col-lg-6 col-sm-6 col-12">
              <div class="form-group">
                <label>Cost</label>
                <input type="number" step="0.01" name="cost" class="form-control" required>
              </div>
            </div>


            {% if user.role == 'admin' %}
            <!-- Manual Date -->
            <div class="col-lg-6 col-sm-6 col-12">
              <div class="form-group">
                <label>Manual Date</label>
                <input type="date" name="manual_date" class="form-control">
              </div>
            </div>
            {% endif %}


            <!-- Notes -->
            <div class="col-lg-12">
              <div class="form-group">
                <label>Notes</label>
                <textarea name="notes" class="form-control" required></textarea>
              </div>
            </div>


            <!-- Flash Messages -->
            <div class="col-lg-12">
              {% with messages = get_flashed_messages(with_categories=true) %}
              {% if messages %}
              <div class="flash-messages">
                {% for category, message in messages %}
                <div
                  class="alert alert-{{ 'danger' if category == 'danger' else 'success' }} alert-dismissible fade show"
                  role="alert">
                  <strong>{{ message }}</strong>
                  <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                {% endfor %}
              </div>
              {% endif %}
              {% endwith %}
            </div>


            <!-- Buttons -->
            <div class="col-lg-12">
              <button type="submit" class="btn btn-submit me-2">Submit</button>
              <a href="/miscitemlist" class="btn btn-cancel">Cancel</a>
            </div>


          </div>
        </div>
      </div>
    </form>


  </div>
</div>
{% endblock %}


{% block scripts %}
<script>
  document.getElementById('type_of_expense').addEventListener('change', function () {
    let selectedOption = this.options[this.selectedIndex];
    let hasSubcategory = selectedOption.getAttribute('data-has-subcategory') === '1';
    let expenseTypeId = selectedOption.value;


    let subCatDiv = document.getElementById('subcategory_div');
    let subCatSelect = document.getElementById('sub_category');
    let loadingDiv = document.getElementById('subcategory_loading');


    // Clear previous subcategories
    subCatSelect.innerHTML = '<option value="">Select Subcategory</option>';


    if (hasSubcategory && expenseTypeId) {
      loadingDiv.style.display = 'block';
      subCatDiv.style.display = 'block';
      subCatSelect.disabled = true;


      fetch(`/get-subcategories/${expenseTypeId}`)
        .then(response => {
          if (!response.ok) throw new Error(`Network response was not ok: ${response.status}`);
          return response.json();
        })
        .then(data => {
          loadingDiv.style.display = 'none';
          subCatSelect.disabled = false;


          if (data.subcategories && data.subcategories.length > 0) {
            data.subcategories.forEach(function (subcategory) {
              let opt = document.createElement('option');
              opt.value = subcategory.id;
              opt.textContent = subcategory.name;
              subCatSelect.appendChild(opt);
            });
          } else {
            let opt = document.createElement('option');
            opt.value = '';
            opt.textContent = 'No subcategories available';
            opt.disabled = true;
            subCatSelect.appendChild(opt);
          }
        })
        .catch(error => {
          console.error('Error fetching subcategories:', error);
          loadingDiv.style.display = 'none';
          subCatSelect.disabled = false;


          let opt = document.createElement('option');
          opt.value = '';
          opt.textContent = 'Error loading subcategories';
          opt.disabled = true;
          subCatSelect.appendChild(opt);
        });
    } else {
      subCatDiv.style.display = 'none';
      loadingDiv.style.display = 'none';
    }
  });


  // Auto-dismiss flash messages after 5 seconds
  document.addEventListener('DOMContentLoaded', function () {
    setTimeout(function () {
      let alerts = document.querySelectorAll('.alert');
      alerts.forEach(function (alert) {
        let closeBtn = alert.querySelector('.btn-close');
        if (closeBtn) closeBtn.click();
      });
    }, 5000);
  });


  // Debug function to check data attributes
  document.addEventListener('DOMContentLoaded', function () {
    const expenseTypeSelect = document.getElementById('type_of_expense');
    console.log('Expense Type Options:', Array.from(expenseTypeSelect.options).map(opt => ({
      text: opt.textContent,
      value: opt.value,
      hasSubcategory: opt.getAttribute('data-has-subcategory')
    })));
  });
</script>
{% endblock %}