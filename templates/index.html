{% extends 'base.html' %}
{% block content %}
<div class="page-wrapper">
    <div class="content">
        <div class="row">
            <div class="col-lg-4 col-sm-6 col-12">
                <div class="dash-widget">
                    <div class="dash-widgetimg">
                        <span><img src="../static/img/icons/dash1.svg" alt="img"></span>
                    </div>
                    <div class="dash-widgetcontent">
                        <h5>&#8377;<span class="counters" id="totalPurchasedAmount">{{
                                cost_details.total_purchased_amount }}</span></h5>
                        <h6>Total Purchase Amount (Rs)</h6>
                    </div>
                </div>
            </div>
            <div class="col-lg-4 col-sm-6 col-12">
                <div class="dash-widget dash1">
                    <div class="dash-widgetimg">
                        <span><img src="../static/img/icons/dash2.svg" alt="img"></span>
                    </div>
                    <div class="dash-widgetcontent">
                        <h5>&#8377;<span class="counters" id="totalPaidAmount">{{ cost_details.total_paid }}</span></h5>
                        <h6>Total Amount Paid (Rs)</h6>
                    </div>
                </div>
            </div>
            <div class="col-lg-4 col-sm-6 col-12">
                <div class="dash-widget dash2">
                    <div class="dash-widgetimg">
                        <span><img src="../static/img/icons/dash4.svg" alt="img"></span>
                    </div>
                    <div class="dash-widgetcontent">
                        <h5>&#8377;<span class="counters" id="totalDueAmount">{{ cost_details.total_due }}</span></h5>
                        <h6>Total Amount Due (Rs)</h6>
                    </div>
                </div>
            </div>
        </div>

        <!-- Purchase Trend Chart -->
        <div class="row mt-4">
            <div class="col-lg-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">Monthly Purchase Trend</h5>
                        <select id="yearSelector" class="form-select w-auto"></select>
                    </div>
                    <div class="card-body">
                        <canvas id="purchaseChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js Library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        let purchaseChart;

        function fetchYears() {
            fetch("/api/years")
                .then(response => response.json())
                .then(data => populateYearDropdown(data.years))
                .catch(error => console.error("Error fetching years:", error));
        }

        function populateYearDropdown(years) {
            const yearSelector = document.getElementById("yearSelector");
            yearSelector.innerHTML = ""; // Clear previous options

            years.forEach(year => {
                const option = document.createElement("option");
                option.value = year;
                option.textContent = year;
                yearSelector.appendChild(option);
            });

            // Fetch data for the latest year by default
            if (years.length > 0) {
                fetchPurchaseData(years[0]);
            }
        }

        function fetchPurchaseData(year) {
            fetch(`/api/purchase_trend?year=${year}`)
                .then(response => response.json())
                .then(data => updateChart(data.months, data.purchase_amounts))
                .catch(error => console.error("Error fetching data:", error));
        }

        function updateChart(labels, data) {
            const ctx = document.getElementById("purchaseChart").getContext("2d");
            if (purchaseChart) purchaseChart.destroy(); // Destroy previous instance

            purchaseChart = new Chart(ctx, {
                type: "line",
                data: {
                    labels: labels,
                    datasets: [{
                        label: "Purchase Amount (Rs)",
                        data: data,
                        borderColor: "#007bff",
                        backgroundColor: "rgba(0, 123, 255, 0.2)",
                        fill: false, // No area fill
                        tension: 0 // Straight lines
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: true }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        document.getElementById("yearSelector").addEventListener("change", function () {
            fetchPurchaseData(this.value);
        });

        fetchYears(); // Load years dynamically on page load
    });
</script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        let amountElement = document.getElementById("totalPurchasedAmount");
        let amount = parseFloat(amountElement.textContent);
        amountElement.textContent = amount.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    });
    document.addEventListener("DOMContentLoaded", function () {
        let amountElement = document.getElementById("totalPaidAmount");
        let amount = parseFloat(amountElement.textContent);
        amountElement.textContent = amount.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    });
    document.addEventListener("DOMContentLoaded", function () {
        let amountElement = document.getElementById("totalDueAmount");
        let amount = parseFloat(amountElement.textContent);
        amountElement.textContent = amount.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    });
</script>
{% endblock %}
