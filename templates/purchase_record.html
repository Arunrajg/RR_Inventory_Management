{% extends 'base.html' %}
{% block content %}
<div class="page-wrapper">
    <div class="content">
        <div class="page-header">
            <div class="page-title">
                <h4>Purchase Record</h4>
            </div>
        </div>

        <div class="card">
            <div class="card-body">
                <!-- Filters Section -->
                <div class="row align-items-end mb-4">
                    <div class="col-md-4">
                        <label for="vendorDropdown" class="form-label">Vendor</label>
                        <input list="vendorList" id="vendorDropdown" class="form-control">
                        <datalist id="vendorList">
                            <option value="All" data-id="all"></option>
                            {% for vendor in vendors %}
                            <option value="{{ vendor.vendor_name }}" data-id="{{ vendor.id }}"></option>
                            {% endfor %}
                        </datalist>
                    </div>
                    <div class="col-md-2">
                        <label for="fromDate" class="form-label">From Date</label>
                        <input type="date" id="from_date" class="form-control" required>
                    </div>
                    <div class="col-md-2">
                        <label for="toDate" class="form-label">To Date</label>
                        <input type="date" id="to_date" class="form-control" required>
                    </div>
                    <div class="col-md-4 text-end">
                        <button id="submitBtn" class="btn btn-primary me-2">Submit</button>
                        <button id="printButton" class="btn btn-secondary" disabled>Print</button>
                    </div>
                </div>

                <!-- Table Section -->
                <div class="table-responsive">
                    <table class="table table-bordered">
                        <thead class="table">
                            <tr>
                                <th>Date</th>
                                <th>Vendor</th>
                                <th>Invoice Number</th>
                                <th>No.of Items</th>
                                <th>Total Cost (Rs)</th>
                                <th>Storage Room</th>
                            </tr>
                        </thead>
                        <tbody id="purchaseTableBody">
                            <tr>
                                <td colspan="7" class="text-center">No data found</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Total Cost Section -->
                <div class="mt-3 text-end">
                    <h5 id="totalCost" class="fw-bold text-primary"></h5>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const vendorInput = document.getElementById('vendorDropdown');
        const vendorList = document.getElementById('vendorList');
        const fromDateInput = document.getElementById('from_date');
        const toDateInput = document.getElementById('to_date');
        const submitButton = document.getElementById('submitBtn');
        const printButton = document.getElementById('printButton');
        const purchaseTableBody = document.getElementById('purchaseTableBody');
        const totalCostField = document.getElementById('totalCost');
        let vendorTotals = [];

        function getVendorId(vendorName) {
            const option = Array.from(vendorList.options).find(opt => opt.value === vendorName);
            return option ? option.getAttribute('data-id') : null;
        }

        function resetTable() {
            purchaseTableBody.innerHTML = '<tr><td colspan="7" class="text-center">No data found</td></tr>';
            totalCostField.textContent = '';
            printButton.disabled = true;
            vendorTotals = [];
        }

        submitButton.addEventListener('click', function () {
            const vendorId = getVendorId(vendorInput.value);
            const fromDate = fromDateInput.value;
            const toDate = toDateInput.value;

            if (!vendorId || !fromDate || !toDate) {
                alert('Please select a vendor and date range');
                return;
            }

            fetch(`/get_purchase_records?vendor_id=${vendorId}&from_date=${fromDate}&to_date=${toDate}`)
                .then(response => response.json())
                .then(data => {
                    if (data.purchases && data.purchases.length > 0) {
                        purchaseTableBody.innerHTML = '';
                        let totalCost = 0;
                        vendorTotals = data.vendor_totals || [];

                        data.purchases.forEach(purchase => {
                            totalCost += parseFloat(purchase.total_cost);
                            const row = `
                            <tr>
                                <td>${purchase.purchase_date}</td>
                                <td>${purchase.vendor_name}</td>
                                <td>${purchase.invoice_number}</td>
                                <td>${purchase.item_count}</td>
                                <td>${purchase.total_cost}</td>
                                <td>${purchase.storageroom_name}</td>
                            </tr>
                        `;
                            purchaseTableBody.insertAdjacentHTML('beforeend', row);
                        });

                        totalCostField.textContent = `Grand Total: Rs. ${totalCost.toFixed(2)}`;
                        printButton.disabled = false;
                    } else {
                        resetTable();
                    }
                })
                .catch(error => {
                    console.error('Error fetching purchase records:', error);
                    resetTable();
                });
        });

        printButton.addEventListener('click', function () {
            let vendorTotalTable = '';
            if (vendorInput.value.toLowerCase() === 'all' && vendorTotals.length > 0) {
                vendorTotalTable = `
                <h3>Vendor-wise Total Purchases</h3>
                <table border="1" width="100%" style="border-collapse: collapse; text-align: center;">
                    <thead>
                        <tr>
                            <th>Vendor</th>
                            <th>Total Cost (Rs)</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${vendorTotals.map(vendor => `
                            <tr>
                                <td>${vendor.vendor_name}</td>
                                <td>${vendor.total_cost}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                <br>
                `;
            }

            const printContent = `
            <div>
                <div style="text-align: center;">
                    <h4 >Purchase Report</h4 >
                </div>
                <div style="text-align: center;">
                    <h2>{{ owner.name }}</h2>
                    <p>Contact: {{ owner.phone_num }}</p>
                    <p>Address: {{ owner.address }}</p>
                </div>
                <p><b>Vendor:</b> ${vendorInput.value}</p>
                <p><b>Date Range:</b> ${fromDateInput.value} to ${toDateInput.value}</p>
                <table border="1" width="100%" style="border-collapse: collapse; text-align: center;">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Vendor</th>
                            <th>Invoice Number</th>
                            <th>No.of Items</th>
                            <th>Total Cost (Rs)</th>
                            <th>Storage Room</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${purchaseTableBody.innerHTML}
                    </tbody>
                </table>
                <br>
                ${vendorTotalTable}
                <p><strong>${totalCostField.textContent}</strong></p>
                <br><br>
                <div style="display: flex; justify-content: space-between;">
                    <p>Authorized Signature: __________</p>
                    <p>Receiver Signature: __________</p>
                </div>
            </div>
            `;

            let iframe = document.createElement('iframe');
            iframe.style.position = 'absolute';
            iframe.style.width = '0px';
            iframe.style.height = '0px';
            iframe.style.border = 'none';
            document.body.appendChild(iframe);
            let doc = iframe.contentWindow.document;
            doc.open();
            doc.write('<html><head></head><body>');
            doc.write(printContent);
            doc.write('</body></html>');
            doc.close();
            iframe.contentWindow.focus();
            iframe.contentWindow.print();
            setTimeout(() => {
                document.body.removeChild(iframe);
            }, 1000);
        });
    });
</script>
{% endblock %}
