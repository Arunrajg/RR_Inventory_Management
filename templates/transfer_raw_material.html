{% extends 'base.html' %}
{% block content %}
<div class="page-wrapper">
    <div class="content">
        <div class="page-header">
            <div class="page-title">
                <h4>Transfer Raw Material</h4>
                <h6>Transfer raw materials from Storage Room to Kitchen or Restaurant</h6>
            </div>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <div class="alert-container">
            {% for category, message in messages %}
            <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
        </div>
        {% endif %}
        {% endwith %}

        <form method="POST" action="/transfer_raw_material">
            <div class="card">
                <div class="card-body">
                    <!-- First Row -->
                    <div class="row">
                        <!-- Transfer Date -->
                        <div class="col-lg-3 col-sm-6 col-12">
                            <div class="form-group">
                                <label>Transfer Date</label>
                                <input type="date" name="transfer_date" class="form-control" value="{{ today_date }}"
                                    required>
                            </div>
                        </div>
                        <!-- Storage Room (Transfer From) -->
                        <div class="col-lg-3 col-sm-6 col-12">
                            <div class="form-group">
                                <label>Transfer From</label>
                                <select name="storageroom" class="form-control" required>
                                    <option value="" disabled selected>Select Storage Room</option>
                                    {% for room in storage_rooms %}
                                    <option value="{{ room.id }}">{{ room.storageroomname }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <!-- Destination -->
                        <div class="col-lg-3 col-sm-6 col-12">
                            <div class="form-group">
                                <label>Destination Type</label>
                                <select name="destination_type" class="form-control" id="destination_type" required>
                                    <option value="kitchen">Kitchen</option>
                                    <option value="restaurant">Restaurant</option>
                                </select>
                            </div>
                        </div>

                        <!-- Destination Name based on selection -->
                        <div class="col-lg-3 col-sm-6 col-12">
                            <div class="form-group">
                                <label>Destination Name</label>
                                <select name="destination_name" class="form-control" id="destination_name" required>
                                    <!-- Dynamic options will be added here -->
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Raw Material Rows -->
                    <div id="raw-material-container">
                        <!-- First Row with Headings -->
                        <div class="row align-items-center raw-material-row">
                            <div class="col-lg-10 col-sm-12 col-12">
                                <div class="form-group row">
                                    <!-- Labels -->
                                    <div class="col-lg-3">
                                        <label>Raw Material</label>
                                        <input list="raw_materials" name="raw_material[]"
                                            class="form-control raw-material-input" placeholder="Select Raw Material"
                                            required>
                                        <datalist id="raw_materials">
                                            {% for material in raw_materials %}
                                            <option value="{{ material.name }}" data-id="{{ material.id }}"
                                                data-metric="{{ material.metric }}"></option>
                                            {% endfor %}
                                        </datalist>
                                        <input type="hidden" class="raw-material-id" name="raw_material_id[]" />
                                    </div>
                                    <!-- Currently Available Quantity -->
                                    <div class="col-lg-2">
                                        <label>Available Quantity</label>
                                        <input type="number" name="available_quantity" class="form-control" step="0.01"
                                            value="" required readonly>
                                    </div>
                                    <div class="col-lg-2">
                                        <label>Transfer Quantity</label>
                                        <input type="number" name="quantity[]" class="form-control transfer-quantity"
                                            step="0.01" placeholder="Enter Quantity" min="0.01" required>
                                    </div>
                                    <div class="col-lg-2">
                                        <label>Metric</label>
                                        <select name="metric_display[]" class="form-control metric-dropdown" disabled>
                                            <option value="kg">Kilogram (kg)</option>
                                            <option value="grams">Grams</option>
                                            <option value="liter">Liter</option>
                                            <option value="ml">Milliliter (ml)</option>
                                            <option value="unit">Unit</option>
                                        </select>
                                        <!-- Hidden input to store metric value for submission -->
                                        <input type="hidden" class="hidden-metric-input" name="metric[]">
                                    </div>
                                    <div class="col-lg-2">
                                        <label>Average Cost Per Unit</label>
                                        <input type="number" name="transfer_avgs[]" class="form-control transfer-avg"
                                            step="0.01" min="0" readonly>
                                    </div>
                                    <div class="col-lg-2">
                                        <label>Total Transfer Cost</label>
                                        <input type="number" name="total_cost[]" class="form-control total-cost"
                                            step="0.01" readonly>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-2 d-flex align-items-center">
                                <button type="button" class="btn btn-success btn-add-row">+</button>
                            </div>
                        </div>
                    </div>

                    <!-- Submit Buttons -->
                    <div class="row mt-3">
                        <div class="col-lg-12">
                            <button type="submit" class="btn btn-submit me-2" id="submit-btn">
                                Submit
                            </button>
                            <span id="loading-text"
                                style="display: none; font-weight: bold; color: blue;">Processing...</span>
                            <a href="/" class="btn btn-cancel">Cancel</a>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const container = document.getElementById('raw-material-container');
        const destinationTypeSelect = document.getElementById('destination_type');
        const destinationNameSelect = document.getElementById('destination_name');
        const storageroomSelect = document.querySelector('select[name="storageroom"]');
        const kitchens = {{ kitchens | tojson
    }};
    const restaurants = {{ restaurants | tojson }};

    function updateDestinationNameOptions() {
        const selectedType = destinationTypeSelect.value;
        let options = [];

        if (selectedType === 'kitchen') {
            options = kitchens;
        } else if (selectedType === 'restaurant') {
            options = restaurants;
        }

        destinationNameSelect.innerHTML = '';
        const defaultOption = document.createElement('option');
        defaultOption.text = 'Select Destination';
        defaultOption.disabled = true;
        defaultOption.selected = true;
        defaultOption.value = "";
        destinationNameSelect.appendChild(defaultOption);

        options.forEach(option => {
            const newOption = document.createElement('option');
            newOption.value = option.id;
            newOption.textContent = option[`${selectedType}name`];
            destinationNameSelect.appendChild(newOption);
        });

        destinationNameSelect.setAttribute('required', 'true');
    }

    destinationTypeSelect.addEventListener('change', updateDestinationNameOptions);
    updateDestinationNameOptions();

    // Add new row
    container.addEventListener('click', function (e) {
        if (e.target.classList.contains('btn-add-row')) {
            const newRow = e.target.closest('.raw-material-row').cloneNode(true);
            newRow.querySelectorAll('input:not([type="hidden"]), select').forEach(input => input.value = '');

            const existingRemoveBtn = newRow.querySelector('.btn-remove-row');
            if (existingRemoveBtn) {
                existingRemoveBtn.remove();
            }

            const addBtn = newRow.querySelector('.btn-add-row');
            addBtn.textContent = '+';
            addBtn.classList.replace('btn-remove-row', 'btn-add-row');
            addBtn.classList.replace('btn-danger', 'btn-success');

            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.textContent = 'X';
            removeBtn.classList.add('btn', 'btn-danger', 'btn-remove-row');
            newRow.querySelector('.d-flex').appendChild(removeBtn);

            const labels = newRow.querySelectorAll('label');
            labels.forEach(label => label.style.display = 'none');

            const metricDropdown = newRow.querySelector('.metric-dropdown');
            if (metricDropdown) {
                metricDropdown.innerHTML = `
                        <option value="kg">Kilogram (kg)</option>
                        <option value="grams">Grams</option>
                        <option value="liter">Liter</option>
                        <option value="ml">Milliliter (ml)</option>
                        <option value="unit">Unit</option>
                    `;
                metricDropdown.disabled = true;
            }

            container.appendChild(newRow);
            const rawMaterialInput = newRow.querySelector('input[name="raw_material[]"]');
            if (rawMaterialInput) {
                rawMaterialInput.focus();
            }
        }
    });

    // Remove row
    container.addEventListener('click', function (e) {
        if (e.target.classList.contains('btn-remove-row')) {
            e.target.closest('.raw-material-row').remove();
        }
    });

    // Handle Enter Key
    container.addEventListener('keydown', function (e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            const addBtn = e.target.closest('.raw-material-row').querySelector('.btn-add-row');
            if (addBtn) addBtn.click();
        }
    });

    // Auto-select metric based on raw material
    container.addEventListener('input', function (e) {
        if (e.target.classList.contains('raw-material-input')) {
            const selectedMaterial = e.target.value;
            const dataList = document.getElementById('raw_materials');
            const options = Array.from(dataList.options);
            const matchingOption = options.find(option => option.value === selectedMaterial);

            if (matchingOption) {
                const metric = matchingOption.dataset.metric;
                const metricDropdown = e.target.closest('.raw-material-row').querySelector('.metric-dropdown');
                const hiddenMetricInput = e.target.closest('.raw-material-row').querySelector('.hidden-metric-input');
                metricDropdown.value = metric;
                hiddenMetricInput.value = metric;
            }
        }
    });

    // Fetch available quantity and average cost (per unit)
    async function fetchAvailableQuantityAndCost(storageroomId, rawMaterialId) {
        try {
            const response = await fetch(`/get_available_quantity?storageroom_id=${storageroomId}&raw_material_id=${rawMaterialId}`);
            if (!response.ok) throw new Error('Failed to fetch available quantity and cost');
            const data = await response.json();
            return {
                available_quantity: data.available_quantity || 0,
                transfer_avgs: data.avg_cost || 0  // Backend sends cost per unit, renamed to match API
            };
        } catch (error) {
            console.error('Error fetching data:', error);
            return { available_quantity: 0, transfer_avgs: 0 };
        }
    }

    // Update available quantity, average cost, and total cost
    async function updateRowData(row, storageroomId, rawMaterialId) {
        const availableQuantityInput = row.querySelector('input[name="available_quantity"]');
        const transferQuantityInput = row.querySelector('input[name="quantity[]"]');
        const transferAvgInput = row.querySelector('input[name="transfer_avgs[]"]');
        const totalCostInput = row.querySelector('input[name="total_cost[]"]');

        const data = await fetchAvailableQuantityAndCost(storageroomId, rawMaterialId);
        availableQuantityInput.value = data.available_quantity.toFixed(2);
        transferQuantityInput.setAttribute('max', data.available_quantity);
        transferAvgInput.value = data.transfer_avgs.toFixed(2);

        // Calculate total cost = transfer_quantity * transfer_avgs
        const transferQuantity = parseFloat(transferQuantityInput.value) || 0;
        totalCostInput.value = (transferQuantity * data.transfer_avgs).toFixed(2);

        // Remove previous event listeners to avoid duplicates
        transferQuantityInput.replaceWith(transferQuantityInput.cloneNode(true));
        const newTransferQuantityInput = row.querySelector('input[name="quantity[]"]');

        // Add event listener for transfer quantity changes
        newTransferQuantityInput.addEventListener('input', function () {
            const quantity = parseFloat(this.value) || 0;
            if (quantity > data.available_quantity) {
                alert('Transfer Quantity cannot exceed Available Quantity.');
                this.value = data.available_quantity.toFixed(2);
            }
            // Recalculate total cost = quantity * transfer_avgs
            const updatedTotalCost = (quantity * data.transfer_avgs).toFixed(2);
            totalCostInput.value = updatedTotalCost;
        });
    }

    container.addEventListener('input', function (e) {
        if (e.target.classList.contains('raw-material-input')) {
            const row = e.target.closest('.raw-material-row');
            const storageroomId = storageroomSelect.value;
            const rawMaterialName = e.target.value;

            const datalist = document.getElementById('raw_materials');
            const option = Array.from(datalist.options).find(opt => opt.value === rawMaterialName);

            if (option) {
                const rawMaterialId = option.getAttribute('data-id');
                const hiddenInput = row.querySelector('.raw-material-id');
                hiddenInput.value = rawMaterialId;
                if (storageroomId && rawMaterialId) {
                    updateRowData(row, storageroomId, rawMaterialId);
                }
            }
        }
    });

    // Also update when storage room changes (refetch for all rows)
    storageroomSelect.addEventListener('change', function () {
        const rows = container.querySelectorAll('.raw-material-row');
        rows.forEach(row => {
            const rawMaterialInput = row.querySelector('.raw-material-input');
            const rawMaterialName = rawMaterialInput.value;
            if (rawMaterialName) {
                const datalist = document.getElementById('raw_materials');
                const option = Array.from(datalist.options).find(opt => opt.value === rawMaterialName);
                if (option) {
                    const rawMaterialId = option.getAttribute('data-id');
                    const hiddenInput = row.querySelector('.raw-material-id');
                    hiddenInput.value = rawMaterialId;
                    if (this.value && rawMaterialId) {
                        updateRowData(row, this.value, rawMaterialId);
                    }
                }
            }
        });
    });

    // Form validation
    const form = document.querySelector('form');
    const rawMaterialsDataList = document.getElementById('raw_materials');
    form.addEventListener('submit', function (e) {
        const rawMaterialInputs = container.querySelectorAll('.raw-material-input');
        const transferQuantityInputs = container.querySelectorAll('.transfer-quantity');
        let isValid = true;

        rawMaterialInputs.forEach(input => {
            const rawMaterialName = input.value;
            const isRawMaterialAvailable = Array.from(rawMaterialsDataList.options).some(
                option => option.value === rawMaterialName
            );

            if (!isRawMaterialAvailable) {
                isValid = false;
                alert(`Raw material "${rawMaterialName}" is not available.`);
                input.focus();
            }
        });

        transferQuantityInputs.forEach(input => {
            const quantity = parseFloat(input.value);
            const max = parseFloat(input.getAttribute('max')) || 0;
            if (isNaN(quantity) || quantity <= 0 || quantity > max) {
                isValid = false;
                alert('Transfer Quantity must be a positive number and not exceed Available Quantity.');
                input.focus();
            }
        });

        if (!isValid) {
            e.preventDefault();
        }
    });

    // Form submission handling
    const submitButton = document.getElementById('submit-btn');
    const loadingText = document.getElementById('loading-text');
    form.addEventListener('submit', function (e) {
        submitButton.disabled = true;
        submitButton.textContent = "Submitting...";
        loadingText.style.display = "inline";
        setTimeout(() => {
            submitButton.disabled = false;
            submitButton.textContent = "Submit";
        }, 60000);
    });
    });
</script>
{% endblock %}