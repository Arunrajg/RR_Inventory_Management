{% extends 'base.html' %}

{% block content %}
<div class="page-wrapper">
    <div class="content">
        <div class="page-header">
            <div class="page-title">
                <h4>Transfer Raw Material</h4>
            </div>
        </div>

        <form action="/transfer_raw_material" method="POST">
            <div class="card">
                <div class="card-body">
                    <div class="row">
                        <!-- Source Inventory Dropdown -->
                        <div class="col-lg-6 col-sm-6 col-12">
                            <div class="form-group">
                                <label>Source Inventory</label>
                                <select name="source_inventory_id" class="form-control" required
                                    onchange="checkAvailableQuantity()">
                                    <option value="" disabled selected>Select Source Inventory</option>
                                    {% for inventory in inventories %}
                                    <option value="{{ inventory.id }}">{{ inventory.inventoryname }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <!-- Raw Material Dropdown -->
                        <div class="col-lg-6 col-sm-6 col-12">
                            <div class="form-group">
                                <label>Raw Material</label>
                                <select name="raw_material_id" class="form-control" required
                                    onchange="checkAvailableQuantity()">
                                    <option value="" disabled selected>Select Raw Material</option>
                                    {% for material in raw_materials %}
                                    <option value="{{ material.id }}" data-max="{{ material.max_quantity }}">{{
                                        material.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <!-- Quantity Input -->
                        <div class="col-lg-6 col-sm-6 col-12">
                            <div class="form-group">
                                <label>Quantity</label>
                                <input type="number" name="quantity" class="form-control" required min="1" step="any"
                                    id="quantity" oninput="checkAvailableQuantity()">
                            </div>
                        </div>

                        <!-- Destination Type (Restaurant/Kitchen) -->
                        <div class="col-lg-6 col-sm-6 col-12">
                            <div class="form-group">
                                <label>Destination Type</label>
                                <select name="destination_type" class="form-control" required
                                    onchange="toggleDestinationField()">
                                    <option value="" disabled selected>Select Destination</option>
                                    <option value="restaurant">Restaurant</option>
                                    <option value="kitchen">Kitchen</option>
                                </select>
                            </div>
                        </div>

                        <!-- Destination ID (Dynamic based on Destination Type) -->
                        <div class="col-lg-6 col-sm-6 col-12" id="destination_id_field" style="display: none;">
                            <div class="form-group">
                                <label id="destination_label">Destination</label>
                                <select name="destination_id" class="form-control" required>
                                    <option value="" disabled selected>Select Destination</option>
                                    <!-- Dynamic options based on destination type will be populated here -->
                                </select>
                            </div>
                        </div>

                        <!-- Dish Dropdown -->
                        <div class="col-lg-6 col-sm-6 col-12">
                            <div class="form-group">
                                <label>Dish</label>
                                <select name="dish_id" class="form-control" required>
                                    <option value="" disabled selected>Select Dish</option>
                                    {% for dish in dishes %}
                                    <option value="{{ dish.id }}">{{ dish.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <!-- Flash messages -->
                        <div>
                            {% with messages = get_flashed_messages(with_categories=true) %}
                            {% if messages %}
                            <ul>
                                {% for category, message in messages %}
                                <li class="{{ category }}"><b>**{{ message }}</b></li>
                                {% endfor %}
                            </ul>
                            {% endif %}
                            {% endwith %}
                        </div>

                        <!-- Submit Button -->
                        <div class="col-lg-12">
                            <button type="submit" class="btn btn-submit me-2">Transfer</button>
                            <a href="/dashboard" class="btn btn-cancel">Cancel</a>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="../static/plugins/select2/js/select2.min.js"></script>
<script src="../static/plugins/sweetalert/sweetalert2.all.min.js"></script>
<script src="../static/plugins/sweetalert/sweetalerts.min.js"></script>

<script>
    function toggleDestinationField() {
        let destinationType = document.querySelector('select[name="destination_type"]').value;
        let destinationField = document.getElementById('destination_id_field');
        let destinationLabel = document.getElementById('destination_label');
        let destinationSelect = document.querySelector('select[name="destination_id"]');

        // Clear the existing options
        destinationSelect.innerHTML = '<option value="" disabled selected>Select Destination</option>';

        if (destinationType === 'restaurant') {
            destinationLabel.innerHTML = 'Restaurant';
            {% for restaurant in restaurants %}
            let option = document.createElement('option');
            option.value = '{{ restaurant.id }}';
            option.innerText = '{{ restaurant.restaurantcode }}';
            destinationSelect.appendChild(option);
            {% endfor %}
        } else if (destinationType === 'kitchen') {
            destinationLabel.innerHTML = 'Kitchen';
            {% for kitchen in kitchens %}
            let option = document.createElement('option');
            option.value = '{{ kitchen.id }}';
            option.innerText = '{{ kitchen.kitchencode }}';
            destinationSelect.appendChild(option);
            {% endfor %}
        }

        // Show or hide the destination field based on the selected destination type
        destinationField.style.display = destinationType ? 'block' : 'none';
    }

    // Check if the quantity exceeds the available stock
    function checkAvailableQuantity() {
        const rawMaterialSelect = document.querySelector('select[name="raw_material_id"]');
        const quantityInput = document.getElementById('quantity');
        const selectedMaterial = rawMaterialSelect.options[rawMaterialSelect.selectedIndex];
        const maxQuantity = parseFloat(selectedMaterial ? selectedMaterial.getAttribute('data-max') : 0);

        const quantity = parseFloat(quantityInput.value);
        if (quantity > maxQuantity) {
            quantityInput.setCustomValidity(`Quantity cannot exceed ${maxQuantity} units`);
        } else {
            quantityInput.setCustomValidity('');
        }
    }

    // Initialize destination field visibility based on selected destination type on page load
    document.addEventListener('DOMContentLoaded', function () {
        toggleDestinationField();
    });
</script>
{% endblock %}
