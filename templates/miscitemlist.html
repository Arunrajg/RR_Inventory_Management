{% extends 'base.html' %}
{% block content %}
<div class="page-wrapper">
  <div class="content">
    <div class="page-header">
      <div class="page-title">
        <h4>Miscellaneous Item List</h4>
      </div>
      {% if user.role == 'admin' %}
      <div class="page-btn">
        <a href="/addmiscitem" class="btn btn-added">
          <img src="../static/img/icons/plus.svg" class="me-1" alt="img">Add Miscellaneous Item
        </a>
      </div>
      {% endif %}
    </div>


    <div class="card">
      <div class="card-body">
        <div class="table-top">
          <div class="search-set">
            <div class="search-input">
              <a class="btn btn-searchset">
                <img src="../static/img/icons/search-white.svg" alt="img">
              </a>
            </div>
          </div>
        </div>


        <div>
          {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
          <ul class="flash-messages">
            {% for category, message in messages %}
            <li class="{{ category }}"><b>{{ message }}</b></li>
            {% endfor %}
          </ul>
          {% endif %}
          {% endwith %}
        </div>


        <div class="table-responsive">
          <table class="table datanew" id="miscTable">
            <thead>
              <tr>
                <th>ID</th>
                <th>Type of Expense</th>
                <th>Sub Category</th>
                <th>Branch</th>
                <th>Branch Manager</th>
                <th>Notes</th>
                <th>Cost</th>
                <th>Date</th>
                <!-- {% if user.role == 'admin' %}
               <th>Actions</th>
               {% endif %} -->
              </tr>
            </thead>


            <tbody>
              {% for item in misc_items %}
              <tr>
                <td style="width: 4%;">{{ loop.index }}</td>
                <td style="width: 10%;">{{ item.type_of_expense or '-' }}</td>
                <td style="width: 10%;">{{ item.sub_category or '-' }}</td>
                <td>{{ item.restaurantname if item.restaurantname else '-' }}</td>
                <td style="width: 8%;">{{ item.branch_manager if item.branch_manager else '-' }}</td>
                <td class="notes-col" style="width: 68%;">{{ item.notes }}</td>
                <td style="width: 15%;">₹ {{ item.cost }}</td>
                <td style="width: 10%; word-break: break-all;">
                  {% if item.manual_date %}
                  {{ item.manual_date.strftime('%d-%m-%Y %I:%M:%S %p') }}
                  {% elif item.created_at %}
                  {{ item.created_at.strftime('%d-%m-%Y %I:%M:%S %p') }}
                  {% else %}
                  -
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>


            <div class="total-summary mb-3 d-flex justify-content-between flex-row-reverse align-items-center">
              <div class="">
                <div class="total-cost-card bg-lightgreen p-3 rounded">
                  <h5 class="mb-0">
                    <i class="fas fa-calculator me-2"></i>
                    Grand Cost:
                    <span class="fw-bold">₹{{ "%.2f"|format(total_cost) }}</span>
                  </h5>
                </div>
              </div>
              <button type="button" id="printButton" class="btn btn-secondary px-5 py-2">
                Print
              </button>
            </div>


          </table>
        </div>
      </div>
    </div>


    <!-- Edit Modal -->
    <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="editModalLabel">Edit Miscellaneous Item</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <form method="POST" action="/editmiscitem">
            <div class="modal-body">
              <input type="hidden" name="id" id="editItemId">


              <!-- Main Category Dropdown -->
              <div class="mb-3">
                <label for="editMainCategory" class="form-label">Main Category</label>
                <select class="form-control" id="editMainCategory" name="expense_type_id" required>
                  <option value="">Select Main Category</option>
                  {% for expense_type in expense_types %}
                  <option value="{{ expense_type.id }}">{{ expense_type.type_name }}</option>
                  {% endfor %}
                </select>
              </div>


              <!-- Sub Category Dropdown -->
              <div class="mb-3" id="subcategory_div_edit" style="display:none;">
                <label for="editSubCategory" class="form-label">Sub Category</label>
                <select class="form-control" id="editSubCategory" name="expense_subcategory_id">
                  <option value="">Select Sub Category</option>
                </select>
                <div id="subcategory_loading_edit" style="display:none;">
                  <small class="text-muted">Loading subcategories...</small>
                </div>
              </div>


              <!-- Restaurant -->
              <div class="mb-3">
                <label for="editRestaurant" class="form-label">Restaurant</label>
                <select class="form-control" id="editRestaurant" name="restaurant_id">
                  <option value="">Select Restaurant</option>
                  {% for restaurant in restaurants %}
                  <option value="{{ restaurant.id }}">{{ restaurant.restaurantname }}</option>
                  {% endfor %}
                </select>
              </div>


              <!-- Branch Manager -->
              <div class="mb-3">
                <label for="editBranchManager" class="form-label">Branch Manager</label>
                <input type="text" class="form-control" id="editBranchManager" name="branch_manager">
              </div>


              <!-- Cost -->
              <div class="mb-3">
                <label for="editCost" class="form-label">Cost</label>
                <input type="number" step="0.01" class="form-control" id="editCost" name="cost" required>
              </div>


              <!-- Notes -->
              <div class="mb-3">
                <label for="editNotes" class="form-label">Notes</label>
                <textarea class="form-control" id="editNotes" name="notes" required></textarea>
              </div>


            </div>


            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              <button type="submit" class="btn btn-primary">Save changes</button>
            </div>
          </form>
        </div>
      </div>
    </div>


  </div>
</div>
{% endblock %}


{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    // AJAX to fetch subcategories for editing
    function fetchSubcategories(expenseTypeId, selectedSubId) {
      const subCatDiv = document.getElementById('subcategory_div_edit');
      const subCatSelect = document.getElementById('editSubCategory');
      const loadingDiv = document.getElementById('subcategory_loading_edit');


      subCatSelect.innerHTML = '<option value="">Select Sub Category</option>';
      loadingDiv.style.display = 'block';
      subCatDiv.style.display = 'block';
      subCatSelect.disabled = true;


      fetch(`/get-subcategories/${expenseTypeId}`)
        .then(response => {
          if (!response.ok) throw new Error(`Network response was not ok: ${response.status}`);
          return response.json();
        })
        .then(data => {
          loadingDiv.style.display = 'none';
          subCatSelect.disabled = false;


          if (data.subcategories && data.subcategories.length > 0) {
            data.subcategories.forEach(function (subcategory) {
              let opt = document.createElement('option');
              opt.value = subcategory.id;
              opt.textContent = subcategory.name;
              if (selectedSubId && selectedSubId == subcategory.id) opt.selected = true;
              subCatSelect.appendChild(opt);
            });
          } else {
            subCatDiv.style.display = 'none';
          }
        })
        .catch(error => {
          console.error('Error fetching subcategories:', error);
          loadingDiv.style.display = 'none';
          subCatDiv.style.display = 'none';
        });
    }


    // Main category change handler for edit modal
    const mainSelect = document.getElementById('editMainCategory');
    mainSelect.addEventListener('change', function () {
      const expenseTypeId = this.value;
      if (expenseTypeId) {
        fetchSubcategories(expenseTypeId, '');
      } else {
        document.getElementById('subcategory_div_edit').style.display = 'none';
      }
    });


    // Edit button click handler
    document.querySelectorAll('.btn-edit').forEach(button => {
      button.addEventListener('click', function () {
        const data = this.dataset;


        // Set basic fields
        document.getElementById('editItemId').value = data.id || '';
        document.getElementById('editCost').value = data.cost || '';
        document.getElementById('editNotes').value = data.notes || '';
        document.getElementById('editBranchManager').value = data.branch_manager || '';


        // Set main category
        document.getElementById('editMainCategory').value = data.expense_type_id || '';


        // Set restaurant dropdown
        const restaurantSelect = document.getElementById('editRestaurant');
        if (data.restaurant_id && data.restaurant_id !== '' && data.restaurant_id !== 'None' && data.restaurant_id !== 'null') {
          restaurantSelect.value = data.restaurant_id;
          if (restaurantSelect.value !== data.restaurant_id) {
            Array.from(restaurantSelect.options).forEach(option => {
              if (option.value == data.restaurant_id) option.selected = true;
            });
          }
        } else {
          restaurantSelect.value = '';
        }


        // Fetch subcategories based on expense type
        const expenseTypeId = data.expense_type_id || '';
        if (expenseTypeId) {
          fetchSubcategories(expenseTypeId, data.expense_subcategory_id);
        } else {
          document.getElementById('subcategory_div_edit').style.display = 'none';
        }
      });
    });
  });


  document.addEventListener('DOMContentLoaded', function () {
    const printButton = document.getElementById('printButton');
    const totalCost = "{{ '%.2f' % total_cost }}";


    function updateGrandTotal() {
      let visibleTotal = 0;
      const table = $('#miscTable').dataTable().api();
      table.rows({ search: 'applied' }).every(function () {
        const rowData = this.data();
        const costValue = rowData[6];
        if (costValue && costValue !== '-') {
          const numericCost = parseFloat(costValue.toString().replace(/[^\d.-]/g, ''));
          if (!isNaN(numericCost)) visibleTotal += numericCost;
        }
      });


      const grandTotalSpan = document.querySelector('.total-cost-card .fw-bold');
      if (grandTotalSpan) grandTotalSpan.textContent = '₹' + visibleTotal.toFixed(2);
      return visibleTotal;
    }


    $('#miscTable').on('search.dt', function () {
      updateGrandTotal();
    });


    $('#miscTable').on('draw.dt', function () {
      updateGrandTotal();
    });


    setTimeout(updateGrandTotal, 100);


    printButton.addEventListener('click', function () {
      const table = $('#miscTable').dataTable().api();
      let allRows = table.rows({ search: 'applied' }).data();
      const currentUrl = window.location.href.split('?')[0];


      const printTotalCost = updateGrandTotal();


      function formatDateDDMMYY(dateString) {
        if (!dateString) return null;
        const date = new Date(dateString);
        if (isNaN(date)) return dateString;
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        return `${day}-${month}-${year}`;
      }


      let rowsHtml = '';
      allRows.each(function (rowData, index) {
        rowsHtml += `
         <tr>
             <td style="padding: 6px; font-size: 10px; vertical-align: top;">${index + 1}</td>
             <td style="padding: 6px; font-size: 10px; vertical-align: top;">${rowData[1] || '-'}</td>
             <td style="padding: 6px; font-size: 10px; vertical-align: top;">${rowData[2] || 'NA'}</td>
             <td style="padding: 6px; font-size: 10px; vertical-align: top;">${rowData[3] || '-'}</td>
             <td style="padding: 6px; font-size: 10px; vertical-align: top;">${rowData[4] || '-'}</td>
             <td style="padding: 6px; font-size: 10px; vertical-align: top;">${rowData[5] || '-'}</td>
             <td style="padding: 6px; font-size: 10px; vertical-align: top;">${(rowData[6] || '-').toString().replace(/[₹$]/g, '')}</td>
             <td style="padding: 6px; font-size: 10px; vertical-align: top;">${formatDateDDMMYY(rowData[7]) || '-'}</td>
         </tr>
       `;
      });


      const printContent = `
       <!DOCTYPE html>
       <html>
       <head>
           <title>Miscellaneous Item Report</title>
           <style>
               @page { margin: 1cm; @top-right { content: "${new Date().toLocaleDateString('en-GB')}:${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}"; font-size: 10pt; } @top-center { content: "Dharani Inventory Solution"; font-size: 12pt; font-weight: bold; } @bottom-left { content: "${currentUrl}"; font-size: 8pt; } @bottom-right { content: "Page " counter(page) " of " counter(pages); font-size: 8pt; } }
               body { margin: 0; }
               .report-title { text-align: start; }
               .company-info { text-align: center; margin-bottom: 20px; }
               table { width: 100%; border-collapse: collapse; text-align: center; table-layout: fixed; margin-bottom: 20px; }
               th, td { padding: 6px; border: 1px solid #000; word-wrap: break-word; word-break: break-word; font-size: 10px; vertical-align: top; line-height: 1.2; }
               .total { text-align: right; margin-top: 20px; }
               .signatures { display: flex; justify-content: space-between; margin-top: 60px; }
               .main-content { margin-top: 0px; }
               .report-header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 20px; width: 100%; }
               .report-header h3 { margin: 0; font-size: 18px; padding-bottom: 2px; }
               .contact-info { text-align: right; font-size: 14px; line-height: 1.4; }
               .contact-info p { margin: 0; }
           </style>
       </head>
       <body>
           <div class="main-content">
               <div class="company-info">
                   <h2>{{ contact_details.name }}</h2>
               </div>
               <div class="report-header">
                   <h3>Miscellaneous Item Report</h3>
                   <div class="contact-info">
                       <p><strong>Contact:</strong> {{ contact_details.contact_number }}</p>
                       <p><strong>Address:</strong> {{ contact_details.address }}</p>
                   </div>
               </div>
               <table>
                   <thead>
                       <tr>
                           <th style="width: 3%;">#</th>
                           <th style="width: 12%;">Type of Expense</th>
                           <th style="width: 10%;">Sub Category</th>
                           <th style="width: 16%;">Branch</th>
                           <th style="width: 12%;">Branch Manager</th>
                           <th style="width: 30%;">Notes</th>
                           <th style="width: 8%;">Cost (₹)</th>
                           <th style="width: 9%;">Date</th>
                       </tr>
                   </thead>
                   <tbody>
                       ${rowsHtml}
                   </tbody>
               </table>
               <div class="total">
                   <h3>Grand Total: ₹ ${printTotalCost.toFixed(2)}</h3>
               </div>
               <div class="signatures">
                   <p>Authorized Signature: __________</p>
                   <p>Receiver Signature: __________</p>
               </div>
           </div>
       </body>
       </html>
     `;


      const iframe = document.createElement('iframe');
      iframe.style.position = 'absolute';
      iframe.style.width = '0px';
      iframe.style.height = '0px';
      iframe.style.border = 'none';
      document.body.appendChild(iframe);


      const doc = iframe.contentWindow.document;
      doc.open();
      doc.write(printContent);
      doc.close();


      iframe.contentWindow.onbeforeprint = function () {
        document.title = "Miscellaneous Item Report";
      };


      iframe.contentWindow.focus();
      setTimeout(function () {
        iframe.contentWindow.document.title = "Miscellaneous Item Report";
        iframe.contentWindow.print();
      }, 200);


      setTimeout(() => {
        document.body.removeChild(iframe);
      }, 1000);
    });
  });
</script>
{% endblock %}