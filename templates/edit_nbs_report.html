{% extends 'base.html' %}

{% block content %}
<div class="page-wrapper">
  <div class="content">
    <div class="page-header">
      <div class="page-title">
        <h4>Edit NBS Daily Report</h4>
        <h6>Editing report for {{ report.report_date.strftime('%d/%m/%y') }}</h6>
      </div>
    </div>

    <div class="card">
      <div class="card-body">
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <div class="flash-messages">
          {% for category, message in messages %}
          <div class="alert alert-{{ category }}">{{ message }}</div>
          {% endfor %}
        </div>
        {% endif %}
        {% endwith %}

        <form method="POST" action="/edit-nbs-report/{{ report.id }}">
          <div class="row">
            <div class="col-md-6">
              <div class="form-group">
                <label for="report_date">Date</label>
                <input type="date" class="form-control" id="report_date" name="report_date"
                  value="{{ report.report_date.strftime('%Y-%m-%d') }}" required>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <label for="restaurant_id">Restaurant</label>
                {% if user.role != 'admin' %}
                <!-- readonly for non-admin -->
                <input type="text" class="form-control" value="{{ report.restaurant_name }}" disabled>
                <input type="hidden" name="restaurant_id" value="{{ report.restaurant_id }}">
                {% else %}
                <select class="form-control" id="restaurant_id" name="restaurant_id" required>
                  {% for r in restaurants %}
                  <option value="{{ r.id }}" {% if r.id==selected_restaurant_id %}selected{% endif %}>
                    {{ r.restaurantname }}
                  </option>
                  {% endfor %}
                </select>
                {% endif %}
              </div>
            </div>
          </div>

          <hr>
          <h5>Income Section</h5>
          <div class="row">
            <div class="col-md-4">
              <div class="form-group">
                <label for="petpooja_total">PetPooja Total</label>
                <input type="number" step="0.01" class="form-control" id="petpooja_total" name="petpooja_total"
                  value="{{ report.petpooja_total }}">
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-group">
                <label for="ns_total">NS Total</label>
                <input type="number" step="0.01" class="form-control" id="ns_total" name="ns_total"
                  value="{{ report.ns_total }}">
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-group">
                <label for="outdoor_catering">Outdoor Catering</label>
                <input type="number" step="0.01" class="form-control" id="outdoor_catering" name="outdoor_catering"
                  value="{{ report.outdoor_catering }}">
              </div>
            </div>
          </div>

          <hr>
          <h5>Payment Methods</h5>
          <div class="row">
            <div class="col-md-4">
              <div class="form-group">
                <label for="upi">UPI</label>
                <input type="number" step="0.01" class="form-control" id="upi" name="upi" value="{{ report.upi }}">
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-group">
                <label for="cash">CASH</label>
                <input type="number" step="0.01" class="form-control" id="cash" name="cash" value="{{ report.cash }}">
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-group">
                <label for="r_expense">Miscellaneous Expense</label>
                <input type="number" step="0.01" class="form-control" id="r_expense" name="r_expense"
                  value="{{ report.r_expense }}">
              </div>
            </div>
          </div>

          <hr>
          <h5>Online Platforms</h5>
          <div class="row">
            <div class="col-md-6">
              <div class="form-group">
                <label for="swiggy">Swiggy</label>
                <input type="number" step="0.01" class="form-control" id="swiggy" name="swiggy"
                  value="{{ report.swiggy }}">
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <label for="zomato">Zomato</label>
                <input type="number" step="0.01" class="form-control" id="zomato" name="zomato"
                  value="{{ report.zomato }}">
              </div>
            </div>
          </div>

          <div class="mt-4">
            <button type="submit" class="btn btn-primary">Update Report</button>
            <a href="{{ url_for('nbs_reports') }}" class="btn btn-secondary">Cancel</a>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    function calculateTotalIncome() {
      const petpooja = parseFloat(document.getElementById('petpooja_total').value) || 0;
      const ns = parseFloat(document.getElementById('ns_total').value) || 0;
      const outdoor = parseFloat(document.getElementById('outdoor_catering').value) || 0;
      console.log('Total Income:', petpooja + ns + outdoor);
    }

    function calculateNetCounter() {
      const upi = parseFloat(document.getElementById('upi').value) || 0;
      const cash = parseFloat(document.getElementById('cash').value) || 0;
      const r_expense = parseFloat(document.getElementById('r_expense').value) || 0;
      console.log('Net Counter:', upi + cash + r_expense);
    }

    ['petpooja_total', 'ns_total', 'outdoor_catering'].forEach(id => {
      document.getElementById(id).addEventListener('input', calculateTotalIncome);
    });
    ['upi', 'cash', 'r_expense'].forEach(id => {
      document.getElementById(id).addEventListener('input', calculateNetCounter);
    });
  });
</script>
{% endblock %}